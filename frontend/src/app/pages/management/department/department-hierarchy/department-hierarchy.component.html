<div class="p-8 max-w-5xl mx-auto font-poppins">
  <!-- Header -->
  <div class="mb-8 border-b border-gray-200 pb-6">
    <div class="flex items-center justify-between gap-4">
      <div class="flex-1">
        <h2 class="text-2xl font-bold text-textDark mb-2 flex items-center gap-2">
          <i class="fas fa-sitemap text-accent text-xl"></i>
          <span>{{ 'department.hierarchy' | translate }}</span>
        </h2>
        <p class="text-sm text-gray-600 mt-1">
          {{ 'department.hierarchyDescription' | translate }}
        </p>
      </div>
    
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="py-16 flex flex-col items-center justify-center">
    <div class="spinner-container">
      <div class="spinner"></div>
      <p class="mt-4 text-accent font-medium text-sm">
        {{ 'department.loadingDepartmentData' | translate }}
      </p>
    </div>
  </div>

  <!-- Empty State -->
  <div
    *ngIf="!isLoading && departmentTree.length === 0"
    class="text-center py-16"
  >
    <i class="fas fa-sitemap text-gray-400 text-4xl mb-4"></i>
    <h3 class="text-xl font-bold text-textDark mb-2">
      {{ 'department.noDepartmentsFound' | translate }}
    </h3>
    <p class="text-sm text-gray-600">
      {{ 'department.noDepartmentsMatching' | translate }}
    </p>
  </div>

  <!-- Tree View -->
  <div
    *ngIf="!isLoading && departmentTree.length > 0"
    class="department-tree-container max-h-[70vh] overflow-y-auto"
  >
    <ul class="tree-list">
      <li *ngFor="let node of departmentTree" class="tree-item">
        <ng-container
          *ngTemplateOutlet="treeNodeTemplate; context: { node: node }"
        ></ng-container>
      </li>
    </ul>
  </div>
</div>

<!-- Recursive Tree Node Template -->
<ng-template #treeNodeTemplate let-node="node">
  <div class="tree-node" [style.padding-left.px]="(node.level || 0) * 24">
    <div class="flex items-center gap-3 py-3 px-4 rounded-lg hover:bg-gray-50 transition-colors mb-1">
      <!-- Expand/Collapse Icon for nodes with children -->
      <button
        *ngIf="node.children && node.children.length > 0"
        (click)="toggleNode(node)"
        class="w-5 h-5 flex items-center justify-center text-gray-500 hover:text-accent transition-colors"
      >
        <i
          class="fas text-xs"
          [ngClass]="node.expanded ? 'fa-chevron-down' : 'fa-chevron-right'"
        ></i>
      </button>
      <div *ngIf="!node.children || node.children.length === 0" class="w-5"></div>

      <!-- Department Icon -->
      <div
        class="w-8 h-8 rounded-full bg-accent/10 flex items-center justify-center flex-shrink-0"
      >
        <i class="fas fa-building text-accent text-xs"></i>
      </div>

      <!-- Department Info -->
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2">
          <span class="text-sm font-semibold text-textDark">
            {{ node.nameEn }}
          </span>
          <span
            *ngIf="node.children && node.children.length > 0"
            class="px-2 py-0.5 bg-accent/20 text-accent rounded-full text-xs font-medium"
          >
            {{ node.children.length }}
            {{
              node.children.length === 1
                ? ('department.child' | translate)
                : ('department.children' | translate)
            }}
          </span>
        </div>
        <div class="text-xs text-gray-500 mt-0.5">
          <span *ngIf="node.organization">
            {{ node.organization.name }}
            <span *ngIf="node.organization.code">({{ node.organization.code }})</span>
          </span>
          <span *ngIf="!node.organization">-</span>
        </div>
      </div>

      <!-- Total Children Count (including grandchildren) -->
      <div
        *ngIf="node.children && node.children.length > 0"
        class="text-xs text-gray-400"
      >
        ({{ getChildrenCount(node) }} total)
      </div>

      <!-- View Users Button -->
      <button
        (click)="showUsers(node); $event.stopPropagation()"
        class="px-3 py-1.5 bg-accent hover:bg-accentDark text-white rounded-lg flex items-center gap-1.5 transition-colors duration-200 text-xs font-medium shadow-sm hover:shadow-md"
        [title]="'department.viewUsers' | translate"
      >
        <i class="fas fa-users text-xs"></i>
        <span>{{ 'department.users' | translate }}</span>
      </button>
    </div>

    <!-- Children (recursive) -->
    <ul
      *ngIf="node.children && node.children.length > 0 && node.expanded"
      class="tree-children"
    >
      <li *ngFor="let child of node.children" class="tree-item">
        <ng-container
          *ngTemplateOutlet="treeNodeTemplate; context: { node: child }"
        ></ng-container>
      </li>
    </ul>
  </div>
</ng-template>

